
(ns anchor.db
  (:require [redlobster.io :as io]
            redlobster.promise
            [cljs.reader :refer [read-string]])
  (:require-macros
    [redlobster.macros :refer [let-realised]])
  )

(def db (atom {"manual-overrides" nil, "manual-values" {"ABP.AX" {"new-project-return" 0.06, "income-asset-value" 2500000000, "new-project-expenditure" 100000000}, "SGP.AX" {}}, "company-metadata" {"SGP.AX" {"favicon?" true, "website" "http://www.stockland.com.au/", "name" "Stockland"}, "J69U.SI" {"name" "Fraser's Centrepoint Trust", "website" "http://www.fraserscentrepointtrust.com/", "favicon?" true}, "0435.HK" {"name" "Sunlight Reit", "website" "http://www.sunlightreit.com/", "favicon?" true}, "0823.HK" {"name" "Link REIT", "website" "http://www.linkreit.com/EN/Pages/default.aspx", "favicon?" false, "favicon-link" "http://www.linkreit.com/_layouts/Link CWS/images/favicon.ico?201508181000"}, "ABP.AX" {"name" "Abacus Property Group", "website" "http://www.abacusproperty.com.au/", "favicon?" false, "favicon-link" "http://www.abacusproperty.com.au/sites/all/themes/abacus/favicon.ico"}, "CATL.SI" {"name" "CapitaLand Ltd", "website" "http://www.capitaland.com/", "favicon?" false, "favicon-link" "http://www.capitaland.com/fcon.ico"}, "0778.HK" {"name" "Fortune REIT", "website" "http://www.fortunereit.com/html/index.php", "favicon?" false, "favicon-link" nil}, "K2LU.SI" {"name" "Cache Logistics Trust", "website" "http://www.cache-reit.com/", "favicon?" false, "favicon-link" "http://www.cache-reit.com/images/Cache.ico"}, "GMG.AX" {"name" "Goodman Group", "website" "http://www.goodman.com/", "favicon?" true, "favicon-link" nil}}, "node-types" {"shares-issued" "Balance Sheet", "cash" "Balance Sheet", "other-assets" "Balance Sheet", "net-income" "Income Statement", "total-liabilities" "Balance Sheet"}, "economic-sectors" {"General" 6, "floo" 5}, "company-sectors" {"SGP.AX" {"General" 100}, "J69U.SI" {"General" 100}, "0435.HK" {"General" 100}, "0823.HK" {"General" 100}, "ABP.AX" {"General" 100}, "CATL.SI" {"General" 100}, "0778.HK" {"General" 100}, "K2LU.SI" {"General" 100}, "GMG.AX" {"General" 100}}, "report-metadata" {"SGP.AX" {"2015 6" {"starting-month" 7, "factor" "k", "year" 2015, "month" 6, "starting-year" 2014}}, "J69U.SI" {"2015 9" {"starting-month" 10, "factor" "k", "year" 2015, "month" 9, "starting-year" 2014}}, "0435.HK" {"2015 9" {"starting-month" 10, "factor" "k", "year" 2015, "month" 9, "starting-year" 2014}}, "0823.HK" {"2014 9" {"starting-month" 4, "factor" "M", "year" 2014, "month" 9, "starting-year" 2014}, "2015 9" {"starting-month" 4, "factor" "M", "year" 2015, "month" 9, "starting-year" 2015}, "2015 3" {"starting-month" 4, "factor" "M", "year" 2015, "month" 3, "starting-year" 2014}}, "ABP.AX" {"2015 6" {"year" 2015, "month" 6, "starting-year" 2014, "starting-month" 7, "factor" "1"}}, "CATL.SI" {"2014 12" {"starting-month" 10, "factor" "k", "year" 2014, "month" 12, "starting-year" 2014}, "2015 6" {"starting-month" 4, "factor" "k", "year" 2015, "month" 6, "starting-year" 2015}, "2015 9" {"starting-month" 7, "factor" "k", "year" 2015, "month" 9, "starting-year" 2015}, "2015 3" {"starting-month" 1, "factor" "k", "year" 2015, "month" 3, "starting-year" 2015}}, "0778.HK" {"2014 12" {"starting-month" 1, "factor" "k", "year" 2014, "month" 12, "starting-year" 2014}}, "K2LU.SI" {"2014 12" {"starting-month" 1, "factor" "k", "year" 2014, "month" 12, "starting-year" 2014}}, "GMG.AX" {"2015 6" {"starting-month" 7, "factor" "k", "year" 2015, "month" 6, "starting-year" 2014}}}, "period-coefficients" {"SGP.AX" "1", "J69U.SI" "1", "INTC" "1 1 1 1", "0435.HK" "1", "0823.HK" "1 1 -1", "ABP.AX" "1", "CATL.SI" "1 1 1 1", "AAPL" "4", "0778.HK" "1", "K2LU.SI" "1", "GMG.AX" "1", "Ocean" "1 2 3"}, "report-values" {"SGP.AX" {"2015 6" {"net-income" {"60" {"107" {"0" {"value" "903", "negative?" false, "page-frac" 60.511449037776195, "left-text" "Profit for the year attributable to securityholders/unitholders "}}}}, "other-assets" {"61" {"86" {"0" {"value" "58", "negative?" false, "page-frac" 61.44687312900927, "left-text" "Property, plant and equipment                                                             "}}, "26" {"0" {"value" "549", "negative?" false, "page-frac" 61.24366571632217, "left-text" "Inventories (C1a) "}}}}, "cash" {"61" {"16" {"0" {"value" "170", "negative?" false, "left-text" "Cash and cash equivalents                                                                0 ", "page-frac" 61.21216179615111}}}}, "total-liabilities" {"61" {"190" {"0" {"value" "6942", "negative?" false, "left-text" "Total liabilities ", "page-frac" 61.790990734141126}}}}}}, "J69U.SI" {"2015 9" {"cash" {"6" {"101" {"0" {"value" "16197", "negative?" false, "left-text" "Cash and cash equivalents", "page-frac" 6.478737517831669}}}}, "other-assets" {"6" {"57" {"0" {"value" "105", "negative?" false, "left-text" "Fixed assets", "page-frac" 6.337486447931527}}, "96" {"0" {"value" "5401", "negative?" false, "left-text" "Trade and other receivables", "page-frac" 6.463021398002853}}, "62" {"0" {"value" "66", "negative?" false, "left-text" "Intangible assets", "page-frac" 6.3531783166904425}}, "74" {"0" {"value" "62823", "negative?" false, "left-text" "Investment in associate ", "page-frac" 6.384562054208274}}}}, "net-income" {"3" {"159" {"0" {"value" "96205", "negative?" false, "left-text" "Net income", "page-frac" 3.5129743223965764}}}}, "total-liabilities" {"6" {"188" {"0" {"value" "794202", "negative?" false, "left-text" "Total liabilities", "page-frac" 6.762796005706134}}}}}}, "0435.HK" {"2015 9" {"cash" {"80" {"47" {"0" {"value" "464334", "negative?" false, "left-text" "464,334", "page-frac" 80.47870208023774}}}}, "other-assets" {"80" {"43" {"0" {"value" "27356", "negative?" false, "left-text" "27,356", "page-frac" 80.45527488855869}}}}, "net-income" {"78" {"22" {"0" {"value" "586580", "negative?" false, "left-text" "586,580", "page-frac" 78.25265230312036}}}}, "total-liabilities" {"81" {"36" {"0" {"value" "4800556", "negative?" false, "left-text" "(4,800,556", "page-frac" 81.35032466567608}}}}}}, "0823.HK" {"2015 9" {"cash" {"51" {"43" {"0" {"value" "494", "negative?" false, "left-text" "    Cash and cash equivalents                                                                                      16", "page-frac" 51.38119762258544}}}}, "other-assets" {"51" {"34" {"0" {"value" "369", "negative?" false, "left-text" "    Trade and other receivables                                                                                     15", "page-frac" 51.34511664190193}}, "37" {"0" {"value" "74", "negative?" false, "left-text" "    Deposits and prepayments", "page-frac" 51.35714338781575}}, "31" {"0" {"value" "1317", "negative?" false, "left-text" "    Investment properties held for sale                                                                          13", "page-frac" 51.33308841010401}}}}, "net-income" {"48" {"20" {"0" {"value" "3096", "negative?" false, "left-text" "Net property income", "page-frac" 48.278469539375926}}}}, "total-liabilities" {"51" {"97" {"0" {"value" "35209", "negative?" false, "left-text" "Total liabilities, excluding net assets attributable to Unitholders ", "page-frac" 51.6963632986627}}}}}, "2015 3" {"net-income" {"61" {"18" {"0" {"value" "5669", "negative?" false, "left-text" "5,669", "page-frac" 61.20595096582466}}}}}, "2014 9" {"net-income" {"48" {"25" {"0" {"value" "2783", "negative?" false, "left-text" "Net property income", "page-frac" 48.27217904903418}}}}}}, "ABP.AX" {"2015 6" {"cash" {"68" {"19" {"1" {"value" "38388", "page-frac" 68.29285317177477, "left-text" "Cash and cash equivalents", "negative?" false}}}}, "other-assets" {"68" {"22" {"1" {"value" "3080", "page-frac" 68.30799928724163, "left-text" "Property, plant and equipment", "negative?" false}}, "25" {"1" {"value" "11680", "page-frac" 68.32314540270848, "left-text" "Trade and other receivables", "negative?" false}}, "13" {"1" {"value" "7464", "page-frac" 68.26256094084106, "left-text" "Inventory", "negative?" false}}}}, "net-income" {"66" {"70" {"1" {"value" "133219", "page-frac" 66.70866429080542, "left-text" "NET PROFIT AFTER TAX", "negative?" false}}}}, "total-liabilities" {"68" {"97" {"1" {"value" "699119", "page-frac" 68.8543834640057, "left-text" "TOTAL LIABILITIES", "negative?" false}}}}}}, "CATL.SI" {"2015 9" {"cash" {"6" {"53" {"6" {"value" "3878051", "negative?" false, "left-text" "   Cash & cash equivalents", "page-frac" 6.35843366186505}}}}, "other-assets" {"6" {"49" {"6" {"value" "1329556", "negative?" false, "left-text" "   Trade & other receivables", "page-frac" 6.342815769522366}}, "60" {"10" {"value" "899026", "negative?" false, "left-text" "          899,026 ", "page-frac" 6.389366186504928}}, "37" {"7" {"value" "1382196", "negative?" false, "left-text" "Other non-current assets", "page-frac" 6.267304018195603}}}}, "net-income" {"2" {"28" {"7" {"value" "318938", "negative?" false, "left-text" "       318,938            226,629          40.7            1,213,809 ", "page-frac" 2.41354586808188}}}}, "total-liabilities" {"6" {"87" {"7" {"value" "7730053", "negative?" false, "left-text" "       7,730,053           7,002,045         10.4         ", "page-frac" 6.497402577710386}}, "102" {"5" {"value" "15008003", "negative?" false, "left-text" "     15,008,003         13,902,912           7.9          ", "page-frac" 6.5880773313116}}}}}, "2015 6" {"net-income" {"2" {"27" {"7" {"value" "638877", "negative?" false, "left-text" "       638,877            424,973          50.3               894,871", "page-frac" 2.3995966641394997}}}}}, "2015 3" {"net-income" {"2" {"24" {"11" {"value" "255994", "negative?" false, "left-text" "           255,994             279,044                (8.3)", "page-frac" 2.3994420015163005}}}}}, "2014 12" {"net-income" {"2" {"30" {"7" {"value" "536359", "negative?" false, "left-text" "       536,359        391,508         37.0             1,467,005      ", "page-frac" 2.41354586808188}}}}}}, "0778.HK" {"2014 12" {"cash" {"12" {"43" {"0" {"value" "688407", "negative?" false, "left-text" "Ba", "page-frac" 12.364905231235785}}}}}}, "K2LU.SI" {"2014 12" {"cash" {"90" {"61" {"0" {"value" "11275", "negative?" false, "left-text" "Cash and cash equivalents", "page-frac" 90.4083977191732}}}}, "other-assets" {"90" {"49" {"0" {"value" "3455", "negative?" false, "left-text" "Trade and other receivables", "page-frac" 90.37292658588738}}, "26" {"0" {"value" "1840", "negative?" false, "left-text" "Plant and equipment", "page-frac" 90.28424875267284}}, "20" {"0" {"value" "75700", "negative?" false, "left-text" "Investment property under development", "page-frac" 90.26651318602994}}}}, "net-income" {"91" {"24" {"0" {"value" "78000", "negative?" false, "left-text" "78,000", "page-frac" 91.26651318602994}}}}, "total-liabilities" {"90" {"114" {"0" {"value" "370159", "negative?" false, "left-text" "370,159", "page-frac" 90.6744319315752}}}}}}, "GMG.AX" {"2015 6" {"cash" {"47" {}, "44" {}, "43" {"21" {"0" {"value" "746.5", "negative?" false, "left-text" "Cash", "page-frac" 43.13784176764077}}}, "46" {}, "45" {}}, "other-assets" {"47" {}, "44" {}, "43" {"25" {"0" {"value" "344.8", "negative?" false, "left-text" "Receivables", "page-frac" 43.15234426229508}}, "29" {"0" {"value" "364.3", "negative?" false, "left-text" "Inventories", "page-frac" 43.1668467569494}}, "52" {"0" {"value" "1067.4", "negative?" false, "left-text" "Inventories", "page-frac" 43.26921810406272}}, "68" {"0" {"value" "234.8", "negative?" false, "left-text" "13", "page-frac" 43.327228795438344}}}, "46" {}, "45" {}}, "net-income" {"47" {}, "44" {"107" {"0" {"value" "1229.2", "negative?" false, "left-text" "Profit for the year", "page-frac" 44.61300213827513}}}, "43" {}, "46" {}, "45" {}}, "total-liabilities" {"47" {}, "44" {}, "43" {"131" {"0" {"value" "3886.2", "negative?" false, "page-frac" 43.6061903064861, "left-text" "Total liabilities"}}}, "46" {}, "45" {}}}}}, "report-manuals" {"SGP.AX" {"2015 6" nil}, "J69U.SI" {"2015 9" nil}, "0435.HK" {"2015 9" nil}, "0823.HK" {"2015 3" nil, "2014 9" nil, "2015 9" nil}, "ABP.AX" {"2014 7" nil, "2015 6" {"net-income" ""}}, "CATL.SI" {"2015 9" nil, "2015 6" nil, "2015 3" nil, "2014 12" nil}, "0778.HK" {"2014 12" {"other-assets" "60,853", "net-income" "1,161,224", "total-liabilities" "11,221,954"}}, "K2LU.SI" {"2014 12" nil}, "GMG.AX" {"2015 6" nil}}, "node-order" {"net-income" 0, "cash" 1, "other-assets" 2, "total-liabilities" 3, "new-project-return" 4, "new-project-expenditure" 5}}))

(defn dump-db []
  (io/spit "resources/db.edn" (pr-str @db)))

(defn load-db []
  (let-realised [s (io/slurp "resources/db.edn")]
                (reset! db (read-string @s))))

(load-db)

(defn set-db
  "Set collection s to contents data"
  [s data]
  (swap! db assoc s data))

(defn get-db
  "Get collection s"
  [s]
  (get @db s))

(defn swap-db
  "Update collection s to (apply f old-val args)"
  [s f & args]
  (set-db s (apply f (get-db s) args)))
